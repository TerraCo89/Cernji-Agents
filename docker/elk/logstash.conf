# Logstash pipeline configuration for platform logs
# Receives JSON logs via HTTP and forwards to Elasticsearch
# Index prefix is configured via INDEX_PREFIX environment variable

input {
  # HTTP input for application logs
  http {
    port => 5001
    codec => json
    type => "application-log"
  }
}

filter {
  # Parse ECS fields if present
  if [ecs][version] {
    mutate {
      add_field => { "[@metadata][ecs_version]" => "%{[ecs][version]}" }
    }
  }

  # Add processing metadata
  mutate {
    add_field => {
      "[@metadata][beat]" => "logstash-http"
      "[@metadata][version]" => "1.0.0"
    }
  }

  # Ensure @timestamp is set
  if ![timestamp] and ![@timestamp] {
    ruby {
      code => "event.set('@timestamp', Time.now)"
    }
  }

  # Copy custom timestamp to @timestamp if present
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "logs-${INDEX_PREFIX:cernji}-%{+YYYY.MM.dd}"

    # Required for data streams
    action => "create"

    # Disable template management (use default)
    manage_template => false
  }

  # Debug output (optional - comment out in production)
  stdout {
    codec => rubydebug {
      metadata => true
    }
  }
}
